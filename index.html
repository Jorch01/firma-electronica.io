<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Firma Electr√≥nica M√©xico - Aplicaci√≥n Web</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Librer√≠as CDN -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Forge parcheado para pdfsign.js - incluye m√©todo signDetached requerido -->
    <script src="js/forge-patched.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üîê Firma Electr√≥nica M√©xico</h1>
                <p class="subtitle">Aplicaci√≥n web 100% en l√≠nea - Todo se procesa en tu navegador</p>
                <div class="security-badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>Tus certificados y documentos nunca salen de tu computadora</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" data-tab="sign">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>
                    Firmar Documento
                </button>
                <button class="tab-button" data-tab="validate">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Validar Firmas
                </button>
                <button class="tab-button" data-tab="batch">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    Firma por Lotes
                </button>
                <button class="tab-button" data-tab="help">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Ayuda
                </button>
            </div>

            <!-- Tab: Firmar Documento -->
            <div id="sign-tab" class="tab-content active">
                <div class="workflow">
                    <!-- Paso 1: Certificado -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h2>Cargar Certificado Digital</h2>
                        </div>
                        <div class="card">
                            <div class="form-group">
                                <label>Tipo de Certificado</label>
                                <div class="radio-group">
                                    <label class="radio-card">
                                        <input type="radio" name="certType" value="EFIRMA_SAT" checked>
                                        <div class="radio-content">
                                            <div class="radio-icon">üèõÔ∏è</div>
                                            <div>
                                                <strong>e.firma SAT</strong>
                                                <span>Archivos .cer + .key</span>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="radio-card">
                                        <input type="radio" name="certType" value="PFX">
                                        <div class="radio-content">
                                            <div class="radio-icon">‚öñÔ∏è</div>
                                            <div>
                                                <strong>Certificado PFX</strong>
                                                <span>Poder Judicial (.pfx, .p12)</span>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="efirma-files" class="cert-upload">
                                <div class="upload-group">
                                    <label class="upload-box" for="cerFile">
                                        <div class="upload-icon">üìÑ</div>
                                        <div class="upload-text">
                                            <strong>Certificado (.cer)</strong>
                                            <span>Clic para seleccionar</span>
                                        </div>
                                        <input type="file" id="cerFile" accept=".cer" hidden>
                                    </label>
                                    <div class="file-info" id="cerInfo"></div>
                                </div>

                                <div class="upload-group">
                                    <label class="upload-box" for="keyFile">
                                        <div class="upload-icon">üîë</div>
                                        <div class="upload-text">
                                            <strong>Llave Privada (.key)</strong>
                                            <span>Clic para seleccionar</span>
                                        </div>
                                        <input type="file" id="keyFile" accept=".key" hidden>
                                    </label>
                                    <div class="file-info" id="keyInfo"></div>
                                </div>
                            </div>

                            <div id="pfx-files" class="cert-upload" style="display: none;">
                                <div class="upload-group">
                                    <label class="upload-box" for="pfxFile">
                                        <div class="upload-icon">üì¶</div>
                                        <div class="upload-text">
                                            <strong>Certificado PFX (.pfx, .p12)</strong>
                                            <span>Clic para seleccionar</span>
                                        </div>
                                        <input type="file" id="pfxFile" accept=".pfx,.p12" hidden>
                                    </label>
                                    <div class="file-info" id="pfxInfo"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="certPassword">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                    Contrase√±a del Certificado
                                </label>
                                <input type="password" id="certPassword" class="text-input" placeholder="Ingrese su contrase√±a">
                            </div>

                            <button id="loadCertButton" class="btn btn-secondary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Cargar y Validar Certificado
                            </button>

                            <div id="certResult" class="result-message"></div>
                        </div>
                    </div>

                    <!-- Paso 2: Documento PDF -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h2>Cargar Documento PDF</h2>
                        </div>
                        <div class="card">
                            <div class="drop-zone" id="pdfDropZone">
                                <div class="drop-zone-icon">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10 9 9 9 8 9"></polyline>
                                    </svg>
                                </div>
                                <h3>Arrastra tu PDF aqu√≠</h3>
                                <p>o haz clic para seleccionar</p>
                                <input type="file" id="pdfFile" accept=".pdf" hidden>
                            </div>
                            <div id="pdfInfo" class="pdf-info"></div>

                            <!-- Visor de PDF con selecci√≥n de √°rea -->
                            <div id="pdfViewer" class="pdf-viewer" style="display: none;">
                                <div class="viewer-toolbar">
                                    <button id="prevPage" class="toolbar-btn">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </button>
                                    <span id="pageInfo">P√°gina 1 de 1</span>
                                    <button id="nextPage" class="toolbar-btn">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>
                                    <div class="toolbar-divider"></div>
                                    <button id="zoomOut" class="toolbar-btn">-</button>
                                    <span id="zoomLevel">100%</span>
                                    <button id="zoomIn" class="toolbar-btn">+</button>
                                </div>
                                <div class="canvas-container">
                                    <canvas id="pdfCanvas"></canvas>
                                    <div id="signatureBox" class="signature-box" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Configurar Firma -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <h2>Configurar Firma</h2>
                        </div>
                        <div class="card">
                            <div class="form-group">
                                <label class="switch-label">
                                    <input type="checkbox" id="visibleSignature" checked>
                                    <span class="switch"></span>
                                    <span>Firma visible en el documento</span>
                                </label>
                            </div>

                            <div id="signatureConfig" class="signature-config">
                                <div class="config-section">
                                    <h4>Posici√≥n de la Firma</h4>
                                    <p class="help-text">
                                        üíª <strong>Desktop:</strong> Haz clic y arrastra con el mouse sobre el PDF<br>
                                        üì± <strong>M√≥vil/Tablet:</strong> Toca y arrastra con el dedo sobre el PDF<br>
                                        <span style="color: var(--secondary-color);">‚úì Las coordenadas se actualizar√°n autom√°ticamente</span>
                                    </p>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>P√°gina</label>
                                            <select id="signaturePage" class="text-input">
                                                <option value="1">P√°gina 1</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Posici√≥n X</label>
                                            <input type="number" id="signatureX" class="text-input" value="50" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label>Posici√≥n Y</label>
                                            <input type="number" id="signatureY" class="text-input" value="700" min="0">
                                        </div>
                                    </div>
                                </div>

                                <div class="config-section">
                                    <h4>Informaci√≥n de la Firma</h4>
                                    <div class="form-group">
                                        <label>Raz√≥n de la firma</label>
                                        <input type="text" id="signReason" class="text-input" value="Firma Electr√≥nica" placeholder="Ej: Aprobaci√≥n de contrato">
                                    </div>
                                    <div class="form-group">
                                        <label>Ubicaci√≥n</label>
                                        <input type="text" id="signLocation" class="text-input" value="M√©xico" placeholder="Ej: Ciudad de M√©xico">
                                    </div>
                                    <div class="form-group">
                                        <label>Informaci√≥n de contacto (opcional)</label>
                                        <input type="text" id="signContact" class="text-input" placeholder="Ej: correo@ejemplo.com">
                                    </div>
                                </div>

                                <div class="config-section">
                                    <h4>Nivel de Certificaci√≥n</h4>
                                    <select id="certLevel" class="text-input">
                                        <option value="0">üìù No certificado - Permite modificaciones y m√°s firmas</option>
                                        <option value="1">üîí Certificado - No se permiten cambios</option>
                                        <option value="2">üìã Certificado - Permite llenar formularios</option>
                                        <option value="3">üí¨ Certificado - Permite anotaciones y formularios</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="includeTimestamp" checked>
                                        <span>Incluir marca de tiempo (timestamp)</span>
                                    </label>
                                </div>
                            </div>

                            <button id="signPdfButton" class="btn btn-primary btn-large">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                Firmar Documento Ahora
                            </button>

                            <div id="signProgress" class="progress-container" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <p class="progress-text">Procesando firma digital...</p>
                            </div>

                            <div id="signResult" class="result-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Validar Firmas -->
            <div id="validate-tab" class="tab-content">
                <div class="card">
                    <h2>Validar Firmas de Documento</h2>
                    <p class="help-text">Sube un PDF firmado para verificar la validez de sus firmas digitales</p>

                    <div class="drop-zone" id="validateDropZone">
                        <div class="drop-zone-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                        </div>
                        <h3>Arrastra el PDF firmado aqu√≠</h3>
                        <p>o haz clic para seleccionar</p>
                        <input type="file" id="validatePdfFile" accept=".pdf" hidden>
                    </div>

                    <button id="validateButton" class="btn btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Validar Firmas
                    </button>

                    <div id="validateResult" class="result-container"></div>
                </div>
            </div>

            <!-- Tab: Firma por Lotes -->
            <div id="batch-tab" class="tab-content">
                <div class="card">
                    <h2>Firma M√∫ltiples Documentos</h2>
                    <p class="help-text">Firma varios PDFs a la vez con el mismo certificado y configuraci√≥n</p>

                    <div class="alert alert-info">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Primero carga tu certificado en la pesta√±a "Firmar Documento"</span>
                    </div>

                    <div class="drop-zone" id="batchDropZone">
                        <div class="drop-zone-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                        </div>
                        <h3>Arrastra m√∫ltiples PDFs aqu√≠</h3>
                        <p>o haz clic para seleccionar varios archivos</p>
                        <input type="file" id="batchPdfFiles" accept=".pdf" multiple hidden>
                    </div>

                    <div id="batchFilesList" class="batch-files-list"></div>

                    <button id="batchSignButton" class="btn btn-primary" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Firmar Todos los Documentos
                    </button>

                    <div id="batchProgress" class="batch-progress" style="display: none;"></div>
                    <div id="batchResult" class="result-container"></div>
                </div>
            </div>

            <!-- Tab: Ayuda -->
            <div id="help-tab" class="tab-content">
                <div class="card">
                    <h2>Ayuda y Preguntas Frecuentes</h2>

                    <div class="faq-section">
                        <details class="faq-item">
                            <summary>¬øC√≥mo funciona esta aplicaci√≥n?</summary>
                            <p>Esta es una aplicaci√≥n web 100% del lado del cliente. Todo el procesamiento ocurre en tu navegador. Tus certificados y documentos NUNCA se env√≠an a ning√∫n servidor. La firma se procesa localmente usando JavaScript y puedes descargar el PDF firmado directamente.</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øEs seguro usar esta aplicaci√≥n?</summary>
                            <p>S√≠, completamente. La aplicaci√≥n funciona offline (puedes desconectar internet despu√©s de cargarla). Tus certificados privados y contrase√±as se procesan solo en la memoria de tu navegador y nunca salen de tu computadora.</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øQu√© certificados son compatibles?</summary>
                            <p><strong>e.firma SAT:</strong> Archivos .cer (certificado) + .key (llave privada)<br>
                            <strong>Certificados PFX:</strong> Archivos .pfx o .p12 (Poder Judicial y otros)</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øC√≥mo coloco la firma en una posici√≥n espec√≠fica?</summary>
                            <p>Una vez que cargues el PDF, aparecer√° un visor. Puedes hacer clic y arrastrar para crear un rect√°ngulo donde quieres colocar la firma visible, o ajustar manualmente las coordenadas X, Y.</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øQu√© significa "nivel de certificaci√≥n"?</summary>
                            <p><strong>No certificado:</strong> El documento puede ser modificado y firmado por otros<br>
                            <strong>Certificado sin cambios:</strong> No se permiten modificaciones<br>
                            <strong>Certificado con formularios:</strong> Solo se puede llenar formularios<br>
                            <strong>Certificado con anotaciones:</strong> Se permiten comentarios y formularios</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øPuedo usar esto sin conexi√≥n a internet?</summary>
                            <p>S√≠! Despu√©s de cargar la p√°gina por primera vez, puedes desconectarte de internet. Todo funciona localmente en tu navegador.</p>
                        </details>

                        <details class="faq-item">
                            <summary>¬øEn qu√© navegadores funciona?</summary>
                            <p>Chrome, Firefox, Edge, Safari y Opera modernos. Se recomienda usar las √∫ltimas versiones para mejor compatibilidad.</p>
                        </details>
                    </div>

                    <div class="help-contact">
                        <h3>¬øNecesitas m√°s ayuda?</h3>
                        <p>Si encuentras alg√∫n problema o tienes preguntas, puedes:</p>
                        <ul>
                            <li>Revisar el c√≥digo fuente (es open source)</li>
                            <li>Reportar un issue en GitHub</li>
                            <li>Consultar la documentaci√≥n t√©cnica</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p id="loadingMessage">Procesando...</p>
        </div>
    </div>

    <!-- Firma PKCS#7 manual - Implementaci√≥n propia sin PDFSIGN -->
    <script src="js/pkcs7Signer.js?v=1762192190"></script>

    <script src="js/certificateHandler.js?v=1762189902"></script>
    <script src="js/pdfSigner.js?v=1762189902"></script>
    <script src="js/pdfValidator.js?v=1762189902"></script>
    <script src="js/pdfViewer.js?v=1762189902"></script>
    <script src="js/app.js?v=1762189902"></script>
    <!-- Build timestamp: 2025-11-03 17:05 UTC - FEAT: PKCS#7 manual ASN.1 implementation -->
</body>
</html>
